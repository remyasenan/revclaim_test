ISA*00*          *00*          *ZZ*412345678      *ZZ*481009834      *<%= Time.now().strftime("%y%m%d")%>*<%= Time.now().strftime("%H%M") %>*U*00401*<%= sprintf("%09d",id_837)%>*0*P*:~
GS*HC*412345678*481009834*<%= Time.now().strftime("%Y%m%d")%>*<%= Time.now().strftime("%H%M") %>*2831*X*004010X098A1~<% @cms1500s.each_with_index do |cms1500, i| %> <% @cmsservicelines =cms1500.service_lines %>
ST*837*<%= sprintf("%04d", offset + i + 1)%>~<%count=1%> <%sl_number=i+1%>
BHT*0019*00*<%= cms1500.job.tiff_number.strip rescue nil%>*<%= Time.now().strftime("%Y%m%d")%>*<%= Time.now().strftime("%H%M") %>*CH~<% count=count+1%>
REF*87*004010X098A1~<% count=count+1%>
NM1*41*2*REVENUEMED*****46*412345678~<% count=count+1%>
PER*IC*Joe Wu*EM*pcn@revenuemed.com~<% count=count+1%>
NM1*40*2*PCN*****46*481009834~<% count=count+1%>
HL*1**20*1~<% count=count+1%>
<% if !cms1500.billing_provider_last_name.blank? or !cms1500.billing_provider_first_name.blank? %><%billing_provider_prefix=1%><%else%><%billing_provider_prefix=2%><%end%>
NM1*85*<%=billing_provider_prefix%><% if !cms1500.billing_provider_last_name.blank? or !cms1500.billing_provider_first_name.blank? %><% if !cms1500.billing_provider_last_name.blank? or !cms1500.billing_provider_npi_id.blank? or !cms1500.federal_tax_id.blank?%>*<%if !cms1500.billing_provider_last_name.blank?%><%= cms1500.billing_provider_last_name.strip.slice(0,35) rescue nil%><%end%><%end%><% if !cms1500.billing_provider_first_name.blank? or !cms1500.billing_provider_npi_id.blank? or !cms1500.federal_tax_id.blank?%>*<% if !cms1500.billing_provider_first_name.blank?%><%= cms1500.billing_provider_first_name.strip.slice(0,25) rescue nil%><%end%><%end%><% if !cms1500.billing_provider_middle_initial.blank? or !cms1500.billing_provider_npi_id.blank? or !cms1500.federal_tax_id.blank?%>*<% if !cms1500.billing_provider_middle_initial.blank?%><%= cms1500.billing_provider_middle_initial.strip rescue nil%><%end%><%end%><% if !cms1500.billing_provider_suffix.blank? or !cms1500.billing_provider_npi_id.blank? or !cms1500.federal_tax_id.blank?%>**<% if !cms1500.billing_provider_suffix.blank?%><%= cms1500.billing_provider_suffix.to_s.strip rescue nil%><%end%><%end%><%if !cms1500.billing_provider_npi_id.blank? or !cms1500.federal_tax_id.blank?%><%if !cms1500.billing_provider_npi_id.blank?%>*XX*<%= cms1500.billing_provider_npi_id.to_s.strip rescue nil%><%else%><%if !cms1500.federal_tax_id.blank?%>*24*<%= cms1500.federal_tax_id.strip rescue nil%><%end%><%end%><%end%>~<%else%>*<%= cms1500.billing_provider_name.strip.slice(0,35) rescue nil%><%if !cms1500.billing_provider_npi_id.blank? or !cms1500.federal_tax_id.blank?%><%if !cms1500.billing_provider_npi_id.blank?%>*****XX*<%= cms1500.billing_provider_npi_id.to_s.strip rescue nil%><%else%><%if !cms1500.federal_tax_id.blank?%>*****24*<%= cms1500.federal_tax_id.strip rescue nil%><%end%><%end%><%end%>~<%end%><% count=count+1%>
<%if !cms1500.billing_provider_address.blank? or !cms1500.billing_provider_name.blank?%>
<%if !cms1500.billing_provider_address.blank?%>N3*<%= cms1500.billing_provider_address.strip rescue nil%><%if !cms1500.billing_provider_address2.blank? %><%= ' '+cms1500.billing_provider_address2.strip rescue nil%><%end%>~<% count=count+1%><%end%>
N4*<%if !cms1500.billing_provider_city.blank? %><%= cms1500.billing_provider_city.strip rescue nil%><%else%>DEFAULT CITY<%end%>*<%if !cms1500.billing_provider_state.blank? and !cms1500.billing_provider_city.blank? and !cms1500.billing_provider_state.blank? and cms1500.billing_provider_state!="--"%><%= cms1500.billing_provider_state.strip rescue nil%><%else%>XX<%end%>*<%if !cms1500.billing_provider_zipcode.blank? and !cms1500.billing_provider_city.blank? %><%= cms1500.billing_provider_zipcode.strip rescue nil%><%else%>99999<%end%>~<% count=count+1%>
<%end%>
<%if !cms1500.federal_tax_id.blank? %>REF*EI*<%=  cms1500.federal_tax_id.strip rescue nil%>~<% count=count+1%><%end%>
<% if !cms1500.billing_provider_non_npi_id.blank? %>REF*G2*<%= cms1500.billing_provider_non_npi_id.strip rescue nil%>~<% count=count+1%><%end%>
HL*2*1*22*<%if !cms1500.patient_relationship_to_insured.blank? %><%if cms1500.patient_relationship_to_insured.strip.upcase=="SELF" %>0<%else%>1<%end%><%end%>~<% count=count+1%>
SBR*P*<%if (cms1500.patient_relationship_to_insured.strip.upcase=="SELF" if cms1500.patient_relationship_to_insured)%>18<%end%>*<%if !cms1500.insured_policy_group_or_feca_number.blank? %><%if (cms1500.insured_policy_group_or_feca_number.strip.upcase!="NONE" if cms1500.insured_policy_group_or_feca_number) %><%if cms1500.insured_policy_group_or_feca_number%><%= cms1500.insured_policy_group_or_feca_number.strip rescue nil%><%end%><% end %><%end%>*<%if !cms1500.insured_plan_name.blank? and (cms1500.insured_plan_name.strip!="~" if cms1500.insured_plan_name) %><%if cms1500.insured_plan_name%><%= cms1500.insured_plan_name.strip rescue nil%><%end%><%end%>*****CI~<% count=count+1%>
<%if !cms1500.insured_last_name.blank? or !cms1500.insured_first_name.blank? or !cms1500.insured_middle_initial.blank? or !cms1500.insured_suffix.blank? or !cms1500.insured_id.blank? %>NM1*IL*1*<%if !cms1500.insured_last_name.blank? %><%= cms1500.insured_last_name.strip.slice(0,35) rescue nil%><%else%>NOT PROVIDED<%end%>*<%if !cms1500.insured_first_name.blank? %><%= cms1500.insured_first_name.strip.slice(0,25) rescue nil%><%else%>NOT PROVIDED<%end%><%if !cms1500.insured_id.blank? or !cms1500.insured_middle_initial.blank?%>*<%if !cms1500.insured_middle_initial.blank? %><%= cms1500.insured_middle_initial.strip rescue nil%><%end%><%end%><%if !cms1500.insured_id.blank? or !cms1500.insured_suffix.blank?%>**<%if !cms1500.insured_suffix.blank?%><%= cms1500.insured_suffix.strip rescue nil%><%end%><%end%><%if !cms1500.insured_id.blank? %>*MI*<%= cms1500.insured_id.strip rescue nil%><%end%>~<% count=count+1%><%end%>
<%if !cms1500.insured_address.blank? %>
N3*<%= cms1500.insured_address.strip rescue nil%><%if !cms1500.insured_address2.blank? %><%= ' '+cms1500.insured_address2.strip rescue nil%><%end%>~<% count=count+1%>
<%if !cms1500.insured_city.blank? %>N4*<%= cms1500.insured_city.strip rescue nil%><%else%>DEFAULT CITY<%end%>*<%if !cms1500.insured_state.blank? and !cms1500.insured_city.blank? and cms1500.insured_state!="--"%><%= cms1500.insured_state.strip rescue nil%><%else%>XX<%end%>*<%if !cms1500.insured_zipcode.blank? and !cms1500.insured_city.blank?%><%= cms1500.insured_zipcode.strip rescue nil%><%else%>99999<%end%>~<% count=count+1%>
<%end%>
<%if !cms1500.insured_dob.blank? or !cms1500.insured_sex.blank? %>DMG*D8*<%if !cms1500.insured_dob.blank? %><%= cms1500.insured_dob.strftime("%Y%m%d").to_s.strip rescue nil%><%else%><%=cms1500.patient_dob.strftime("%Y%m%d").to_s.strip rescue nil%><%end%><%if !cms1500.insured_sex.blank? %>*<%= cms1500.insured_sex.strip rescue nil%><%end%>~<% count=count+1%><%end%>
<%if !cms1500.insured_plan_name.blank?%>
<%if !cms1500.insured_plan_name.blank? or !cms1500.insured_policy_group_or_feca_number.blank? %><%if !cms1500.insured_plan_name.blank?%>NM1*PR*2*<%= cms1500.insured_plan_name.strip rescue nil%><%if !cms1500.insured_policy_group_or_feca_number.blank? %>*****PI*<%= cms1500.insured_policy_group_or_feca_number.strip rescue nil%><%end%><%end%>~<% count=count+1%><%end%>
<%if !cms1500.payer.pay_address_one.blank?%>N3*<%=cms1500.payer.pay_address_one.strip rescue nil%>~<% count=count+1%><%end%>
<%if !cms1500.payer.city.blank? %>N4*<%=cms1500.payer.city.strip rescue nil%>*<%=cms1500.payer.state.strip rescue nil%>*<%=cms1500.payer.zipcode.strip rescue nil%>~<% count=count+1%><%end%>
<%end%>
<%if !cms1500.patient_relationship_to_insured.blank?%>
<%if cms1500.patient_relationship_to_insured.strip.upcase!="SELF" %>
HL*3*2*23*0~<% count = count + 1%>
<%if cms1500.patient_relationship_to_insured.strip.upcase!="NONE" %>
PAT*<%if cms1500.patient_relationship_to_insured.strip.upcase=="SPOUSE" %>01<%end%><%if cms1500.patient_relationship_to_insured.strip.upcase=="CHILD" %>19<%end%><%if cms1500.patient_relationship_to_insured.strip.upcase=="OTHERS" %>G8<%end%>~<%count = count + 1 %>
<%end%>
<%if !cms1500.patient_first_name.blank? or !cms1500.patient_last_name.blank?%>
NM1*QC*1<%if !cms1500.patient_last_name.blank? or !cms1500.insured_id.blank? %>*<%if !cms1500.patient_last_name.blank?%><%= cms1500.patient_last_name.strip.slice(0,35) rescue nil%><%end%><%end%><%if !cms1500.patient_first_name.blank? or !cms1500.insured_id.blank? %>*<%if !cms1500.patient_first_name.blank?%><%= cms1500.patient_first_name.strip.slice(0,25) rescue nil%><%end%><%end%><% if !cms1500.patient_middle_initial.blank? or !cms1500.insured_id.blank? %>*<% if !cms1500.patient_middle_initial.blank?%><%= cms1500.patient_middle_initial.strip rescue nil%><%end%><%end%><% if !cms1500.patient_suffix.blank? or !cms1500.insured_id.blank? %>**<%if !cms1500.patient_suffix.blank?%><%= cms1500.patient_suffix.strip rescue nil%><%end%><%end%><%if !cms1500.insured_id.blank? %>*MI*<%= cms1500.insured_id.strip rescue nil%><%end%>~<%count = count + 1%>
<%if !cms1500.patient_address.blank?%>
N3*<%= cms1500.patient_address.strip rescue nil%><%if !cms1500.patient_address2.blank? %><%= ' '+cms1500.patient_address2.strip rescue nil%><%end%>~<%count = count + 1%>
N4*<%if !cms1500.patient_city.blank? %><%= cms1500.patient_city.strip rescue nil%><%else%>DEFAULT CITY<%end%>*<%if !cms1500.patient_state.blank? and !cms1500.patient_city.blank? and cms1500.patient_state!="--"%><%= cms1500.patient_state.strip rescue nil%><%else%>XX<%end%>*<%if !cms1500.patient_zipcode.blank? and !cms1500.patient_city.blank?%><%= cms1500.patient_zipcode.strip rescue nil%><%else%>99999<%end%>~<% count=count+1%>
<%end%>
<%if !cms1500.patient_dob.blank? or !cms1500.patient_sex.blank?%>DMG*D8*<%if !cms1500.patient_dob.blank?%><%=cms1500.patient_dob.strftime("%Y%m%d").to_s.strip rescue nil%><%end%><%if !cms1500.patient_sex.blank?%>*<%=cms1500.patient_sex.strip rescue nil%><%end%>~<%count=count+1%><%end%>
<%if !cms1500.insured_policy_group_or_feca_number.blank?%>REF*IG*<%= cms1500.insured_policy_group_or_feca_number.strip rescue nil%>~<%count = count + 1%><%end%>
<%end%>
<%end%>
<%end%>
<% total_charge = ""%><% if !cms1500.total_charge.blank? %><% total_charge = cms1500.total_charge.to_s %> <% total_decimal=total_charge.split(".") %> <% if total_decimal[1]== "00" or total_decimal[1]== "0" %> <% total_charge=total_decimal[0]%> <% end%><%end%>
<% if !cms1500.patient_account_number.blank? or !cms1500.total_charge.blank? or (!@cmsservicelines[0].service_place.blank? if @cmsservicelines[0]) %>CLM*<% if !cms1500.patient_account_number.blank?%><%if cms1500.patient_account_number%><%= cms1500.patient_account_number.strip rescue nil%><%end%><%end%>*<%if total_charge%><%= total_charge.strip rescue nil%><%end%><% if @cmsservicelines[0]%>***<%if @cmsservicelines[0].service_place%><%= @cmsservicelines[0].service_place.strip rescue nil%><%end%><%end%><% if !cms1500.physician_last_name.blank? or !cms1500.physician_first_name.blank? or (!cms1500.physician_signature_on_file.blank? and (cms1500.physician_signature_on_file.to_s.strip.upcase=="YES" if cms1500.physician_signature_on_file))%>::1*Y<%else%>::1*N<%end%><% if cms1500.accept_assignment=="Yes" %>*A<%else%>*C<%end%><% if !cms1500.patient_signature_on_file.blank? and !cms1500.insured_signature_on_file.blank? %>*Y*Y*B<%else%><%if !cms1500.insured_signature_on_file.blank?%>*Y*Y*M<%end%><% if !cms1500.patient_signature_on_file.blank?%>*Y*Y*S<%end%><%end%><% if cms1500.patient_condition_to_auto_accident=="Yes" and cms1500.patient_condition_to_employment!="Yes" and cms1500.patient_condition_to_other_accident!="Yes"%>*AA<%end%><% if cms1500.patient_condition_to_auto_accident!="Yes" and cms1500.patient_condition_to_employment=="Yes" and cms1500.patient_condition_to_other_accident!="Yes"%>*EM<%end%><% if cms1500.patient_condition_to_auto_accident!="Yes" and cms1500.patient_condition_to_employment!="Yes" and cms1500.patient_condition_to_other_accident=="Yes"%>*OA<%end%><% symbol = ':' %><%symbol_flag = 0%><% if cms1500.patient_condition_to_auto_accident=="Yes"and cms1500.patient_condition_to_employment=="Yes" and cms1500.patient_condition_to_other_accident=="Yes"%><%symbol_flag=2%>*AA<%= symbol%>EM<%=symbol%>OA<%end%><% if cms1500.patient_condition_to_auto_accident=="Yes"and cms1500.patient_condition_to_employment=="Yes" and cms1500.patient_condition_to_other_accident!="Yes"%><%symbol_flag=1%>*AA<%= symbol%>EM<%end%><% if cms1500.patient_condition_to_auto_accident=="Yes"and cms1500.patient_condition_to_employment!="Yes" and cms1500.patient_condition_to_other_accident=="Yes"%><%symbol_flag=1%>*AA<%= symbol%>OA<%end%><% if cms1500.patient_condition_to_auto_accident!="Yes"and cms1500.patient_condition_to_employment=="Yes" and cms1500.patient_condition_to_other_accident=="Yes"%><%symbol_flag=1%>*EM<%=symbol%>OA<%end%><%if symbol_flag==0%><% temp = ":::" %><%elsif symbol_flag==1%><%temp = "::"%><%elsif symbol_flag==2%><%temp = ":"%> <%end%><% if cms1500.patient_condition_to_auto_accident=="Yes"%><%if !cms1500.patient_condition_to_auto_accident_place.blank?%><%= temp + cms1500.patient_condition_to_auto_accident_place.strip rescue nil%><%end%><%end%><% count=count+1%>~<%end%>
<% if cms1500.patient_condition_to_auto_accident=="Yes" or cms1500.patient_condition_to_other_accident=="Yes"%>
<% if !cms1500.date_of_current_illness.blank? %>DTP*439*D8*<%=  cms1500.date_of_current_illness.to_s.strip.split("-").join rescue nil%>~<% count=count+1%><% end %>
<% else %>
<% if !cms1500.date_of_current_illness.blank? %>DTP*431*D8*<%=  cms1500.date_of_current_illness.to_s.strip.split("-").join rescue nil%>~<% count=count+1%><% end %>
<% end %>
<% if !cms1500.first_date_similar_illness.blank? %>DTP*438*D8*<%= cms1500.first_date_similar_illness.to_s.strip.split("-").join rescue nil%>~<% count=count+1%><% end %>
<% if !cms1500.patient_unable_to_work_from_date.blank? %>DTP*360*D8*<%= cms1500.patient_unable_to_work_from_date.to_s.strip.split("-").join rescue nil%>~ <% count=count+1%><% end %>
<% if !cms1500.patient_unable_to_work_to_date.blank? %>DTP*361*D8*<%= cms1500.patient_unable_to_work_to_date.to_s.strip.split("-").join rescue nil%>~ <% count=count+1%><% end %>
<% if !cms1500.hospitalization_from_date.blank? %>DTP*435*D8*<%= cms1500.hospitalization_from_date.to_s.strip.split("-").join rescue nil%>~ <% count=count+1%><% end %>
<% if !cms1500.hospitalization_to_date.blank? %>DTP*096*D8*<%= cms1500.hospitalization_to_date.to_s.strip.split("-").join rescue nil%>~ <% count=count+1%><% end %>
<%if cms1500.amount_paid.to_i > 0 %>AMT*F5*<%= cms1500.amount_paid%>~<%count=count+1%><%end%>
<% if !cms1500.prior_authorization_number.blank? %><% cms_prior_number = cms1500.prior_authorization_number.split("/") %><% if cms_prior_number.length == 2 %><%= "REF*G1*"+cms_prior_number[0].strip rescue nil%>~<% count=count+1%>
<%= "REF*G1*"+cms_prior_number[1].strip rescue nil%>~<% count=count+1%><%else%>
<%= "REF*G1*"+cms1500.prior_authorization_number.strip rescue nil%><% count=count+1%>~<%end%><% end %>
<% if !cms1500.job.tiff_number.blank? %>REF*D9*<%= cms1500.job.tiff_number.strip rescue nil%><% count=count+1%>~<%end%>
<% cms_injury_1=""%><%cms_injury_2=""%><% cms_injury_3="" %><% cms_injury_4="" %>
<%if !cms1500.nature_of_illness_or_injury_1.blank? %><%cms_injury_1= ":"+cms1500.nature_of_illness_or_injury_1 %> <% end %>
<%if !cms1500.nature_of_illness_or_injury_2.blank? %><% cms_injury_2= "*BF:"+cms1500.nature_of_illness_or_injury_2 %><% end %>
<%if !cms1500.nature_of_illness_or_injury_3.blank?%><% cms_injury_3= "*BF:"+cms1500.nature_of_illness_or_injury_3 %><%end%>
<%if !cms1500.nature_of_illness_or_injury_4.blank? %><% cms_injury_4= "*BF:"+cms1500.nature_of_illness_or_injury_4 %> <% end %>
<%if !cms1500.nature_of_illness_or_injury_5.blank? %><% cms_injury_5= "*BF:"+cms1500.nature_of_illness_or_injury_5 %> <% end %>
<%if !cms1500.nature_of_illness_or_injury_6.blank? %><% cms_injury_6= "*BF:"+cms1500.nature_of_illness_or_injury_6 %> <% end %>
<%if !cms1500.nature_of_illness_or_injury_7.blank? %><% cms_injury_7= "*BF:"+cms1500.nature_of_illness_or_injury_7 %> <% end %>
<%if !cms1500.nature_of_illness_or_injury_8.blank? %><% cms_injury_8= "*BF:"+cms1500.nature_of_illness_or_injury_8 %> <% end %>
<%if !cms1500.nature_of_illness_or_injury_9.blank? %><% cms_injury_9= "*BF:"+cms1500.nature_of_illness_or_injury_9 %> <% end %>
<%if !cms1500.nature_of_illness_or_injury_0.blank? %><% cms_injury_0= "*BF:"+cms1500.nature_of_illness_or_injury_0 %> <% end %>
<%if !cms_injury_1.blank? or !cms_injury_2.blank? or !cms_injury_3.blank? or !cms_injury_4.blank? or !cms_injury_5.blank? or !cms_injury_6.blank? or !cms_injury_7.blank? or !cms_injury_8.blank? or !cms_injury_9.blank? or !cms_injury_0.blank? %>
HI*BK<%if !cms_injury_1.blank?%><%= cms_injury_1.strip rescue nil%><%end%><%if !cms_injury_2.blank?%><%=cms_injury_2.strip rescue nil%><%end%><%if !cms_injury_3.blank?%><%= cms_injury_3.strip rescue nil%><%end%><%if !cms_injury_4.blank?%><%= cms_injury_4.strip rescue nil%><%end%><%if !cms_injury_5.blank?%><%= cms_injury_5.strip rescue nil%><%end%><%if !cms_injury_6.blank?%><%= cms_injury_6.strip rescue nil%><%end%><%if !cms_injury_7.blank?%><%= cms_injury_7.strip rescue nil%><%end%><%if !cms_injury_8.blank?%><%= cms_injury_8.strip rescue nil%><%end%><%if !cms_injury_9.blank?%><%= cms_injury_9.strip rescue nil%><%end%><%if !cms_injury_0.blank?%><%= cms_injury_0.strip rescue nil%><%end%>~<% count=count+1%>
<%end%>
<% if !cms1500.reffering_provider_organisation_name.blank? or !cms1500.referring_provider_last_name.blank? or !cms1500.referring_provider_first_name.blank? or !cms1500.referring_provider_npi_id.blank? or !cms1500.referring_provider_middle_initial.blank?%>
NM1*DN*<%if !cms1500.reffering_provider_organisation_name.blank? %>2*<%= cms1500.reffering_provider_organisation_name.strip rescue nil%>*<%else%><% if !cms1500.referring_provider_last_name.blank? or !cms1500.referring_provider_npi_id.blank? or !cms1500.referring_provider_first_name.blank? %>1*<%if !cms1500.referring_provider_last_name.blank? %><%=  cms1500.referring_provider_last_name.strip.slice(0,35) %><%else%>NOT PROVIDED<%end%><%end%><% if !cms1500.referring_provider_first_name.blank? or !cms1500.referring_provider_npi_id.blank?%>*<%if !cms1500.referring_provider_first_name.blank?%><%= cms1500.referring_provider_first_name.strip.slice(0,25) %><%else%>NOT PROVIDED<%end%><%end%><%end%><% if !cms1500.referring_provider_middle_initial.blank? or !cms1500.referring_provider_suffix.blank? or !cms1500.referring_provider_npi_id.blank?%>*<% if !cms1500.referring_provider_middle_initial.blank?%><%=  cms1500.referring_provider_middle_initial.strip rescue nil%><%end%><%end%>**<% if !cms1500.referring_provider_suffix.blank? or !cms1500.referring_provider_npi_id.blank?%><% if !cms1500.referring_provider_suffix.blank?%><%= cms1500.referring_provider_suffix.strip rescue nil%><%end%><%end%><%if !cms1500.referring_provider_npi_id.blank?%>*XX*<%= cms1500.referring_provider_npi_id.to_s.strip rescue nil%><%end%>~<% count=count+1%>
PRV*RF*ZZ*208D00000X~<% count=count+1%>
<%end%>
<%if !cms1500.referring_provider_first_name.blank? or !cms1500.referring_provider_last_name.blank? or !cms1500.referring_provider_npi_id.blank?%>
<%if !cms1500.referring_provider_other_qualifier.blank? or !cms1500.referring_provider_other_id.blank?%>
<% if !cms1500.referring_provider_other_id.blank?%>REF*<%= cms1500.referring_provider_other_qualifier_for_837.strip rescue nil%>*<%= cms1500.referring_provider_other_id.strip rescue nil%>~<% count=count+1%><%end%>
<%end%>
<%end%>
NM1*82*<% if !cms1500.physician_last_name.blank? or !cms1500.physician_first_name.blank? %>1*<% if !cms1500.physician_last_name.blank? %><%= cms1500.physician_last_name.strip.slice(0,35) rescue nil%><% else %>NOT PROVIDED<% end %>*<% if !cms1500.physician_first_name.blank? %><%=  cms1500.physician_first_name.strip.slice(0,25) rescue nil%><% else %>NOT PROVIDED<% end %>*<% if !cms1500.physician_middle_initial.blank? %><%= cms1500.physician_middle_initial.strip rescue nil%><% end %>**<% if !cms1500.physician_suffix.blank? %><%= cms1500.physician_suffix.strip rescue nil%><% end %><% elsif !cms1500.physician_organisation_name.blank? %>2*<%= cms1500.physician_organisation_name.strip.slice(0,25) rescue nil%>****<% else %>1*NOT PROVIDED*NOT PROVIDED<% end %><% if !cms1500.physician_last_name.blank? or !cms1500.physician_first_name.blank? or !cms1500.physician_organisation_name.blank? %><%if @cmsservicelines[0]%><% if !@cmsservicelines[0].rendering_provider_qualifier_npi_id.blank? and !@cmsservicelines[0].rendering_provider_qualifier_npi_id.nil? %>*XX*<%= @cmsservicelines[0].rendering_provider_qualifier_npi_id.to_s.strip rescue nil%><% elsif !cms1500.federal_tax_id.blank? and  !cms1500.federal_tax_id.nil? %>*24*<%= cms1500.federal_tax_id.strip rescue nil%><% elsif !@cmsservicelines[0].rendering_provider_id.blank? and !@cmsservicelines[0].rendering_provider_id.nil? %>*24*<%= @cmsservicelines[0].rendering_provider_id.strip rescue nil%><% end %><% end %><%end%>~<% count=count+1%>
PRV*PE*ZZ*208D00000X~<% count=count+1%>
<% if !cms1500.federal_tax_id.blank? %><% if cms1500.federal_tax_id_type == "EIN" %>REF*EI*<% else %>REF*SY*<% end %><%= cms1500.federal_tax_id.strip rescue nil%>~<% count=count+1%><% end %>
<%if (!@cmsservicelines[0].qual_id.blank? if @cmsservicelines[0]) or (!@cmsservicelines[0].rendering_provider_id.blank? if @cmsservicelines[0])%>
<% if !@cmsservicelines[0].rendering_provider_id.blank?%>REF*<%= @cmsservicelines[0].qual_id_for_837_in_loop_2310b.strip rescue nil%>*<%= @cmsservicelines[0].rendering_provider_id.strip rescue nil%>~<% count=count+1%><%end%>
<%end%>
<% if !cms1500.service_facility_name.blank? %><% if !cms1500.service_facility_name.blank? %>NM1*77*2*<% if !cms1500.service_facility_name.blank? %><%= cms1500.service_facility_name.strip.slice(0,35) rescue nil%><%else%>NOT PROVIDED<%end%><% if !cms1500.service_facility_npi_id.blank? %>*****XX*<%= cms1500.service_facility_npi_id.to_s.strip rescue nil%><%end%>~<% count=count+1%><%end%>
<% if !cms1500.service_facility_address.blank?%>N3*<% if !cms1500.service_facility_address.blank?%><%= cms1500.service_facility_address.strip rescue nil%><%else%>NOT PROVIDED<%end%><%if !cms1500.service_facility_address2.blank? %><%= ' '+cms1500.service_facility_address2.strip rescue nil%><%end%>~<% count=count+1%><%end%>
<% if !cms1500.service_facility_city.blank? or !cms1500.service_facility_state.blank? or !cms1500.service_facility_zipcode.blank?%>N4*<% if !cms1500.service_facility_city.blank? %><%= cms1500.service_facility_city.strip rescue nil%><%else%>DEFAULT CITY<%end%>*<% if !cms1500.service_facility_state.blank? and !cms1500.service_facility_city.blank? and cms1500.service_facility_state!="--"%><%= cms1500.service_facility_state.strip rescue nil%><%else%>XX<%end%>*<% if !cms1500.service_facility_zipcode.blank? and !cms1500.service_facility_city.blank?%><%= cms1500.service_facility_zipcode.strip rescue nil%><%else%>99999<%end%>~<% count=count+1%><%end%>
<% if !cms1500.service_facility_non_npi_id.blank?%>REF*G2*<%= cms1500.service_facility_non_npi_id.strip rescue nil%>~<% count=count+1%><%end%>
<% if !cms1500.service_facility_name.blank? or !cms1500.service_facility_npi_id.blank? %><% if !cms1500.federal_tax_id.blank? %><%if cms1500.federal_tax_id_type == "EIN"%>REF*EI*<%else%>REF*SY*<%end%><%= cms1500.federal_tax_id.strip rescue nil%>~<% count=count+1%><%end%><%end%><%end%>
<%if !cms1500.other_insured_last_name.blank? or !cms1500.other_insured_first_name.blank? or !cms1500.other_insured_middle_initial.blank? or !cms1500.other_insured_suffix.blank? %>NM1*IL*1*<%if !cms1500.other_insured_last_name.blank? %><%= cms1500.other_insured_last_name.strip.slice(0,35) rescue nil%><%else%>NOT PROVIDED<%end%>*<%if !cms1500.other_insured_first_name.blank? %><%= cms1500.other_insured_first_name.strip.slice(0,25) rescue nil%><%else%>NOT PROVIDED<%end%><%if !cms1500.other_insured_middle_initial.blank?%>*<%= cms1500.other_insured_middle_initial.strip rescue nil%><%end%><%if !cms1500.other_insured_suffix.blank?%>**<%= cms1500.other_insured_suffix.strip rescue nil%><%end%>~<% count=count+1%><%end%>
<% if !cms1500.other_insured_policy_or_group_number.blank? %>REF*IG*<%= cms1500.other_insured_policy_or_group_number %>~<% count=count+1%><%end%>
<% if !cms1500.other_insured_insurance_plan_name.blank? %>NM1*PR*2*<%= cms1500.other_insured_insurance_plan_name %>~<% count=count+1%><%end%>
<% if @cmsservicelines %> <%k1=0%><% for j in 0 .. @cmsservicelines.length-1%><%cms_service_days_units=""%>
<%unless @cmsservicelines[j].service_from_date.nil?%>
LX*<%=j+1 %><%count=count+1%>~ <% modifier1=""%><%modifier2=""%><%modifier3=""%><%modifier4=""%>
<% if !@cmsservicelines[j].modifier1.blank? %>  <% modifier1=":"+ @cmsservicelines[j].modifier1%> <%end%>
<%if !@cmsservicelines[j].modifier2.blank? %> <%modifier2=":"+ @cmsservicelines[j].modifier2%> <%end%>
<%if !@cmsservicelines[j].modifier3.blank?%> <% modifier3=":"+@cmsservicelines[j].modifier3%> <%end%>
<%if !@cmsservicelines[j].modifier4.blank? %> <%modifier4=":"+ @cmsservicelines[j].modifier4%> <%end%>
<%if !@cmsservicelines[j].minutes.blank? %> <%minutes= @cmsservicelines[j].minutes%> <%end%>
<% if !@cmsservicelines[j].days_units.blank?%> <% if @cmsservicelines[j].days_units.to_i >0%> <%cms_service_days_units=@cmsservicelines[j].days_units.to_s%><% total_cms_service_days_units=cms_service_days_units.split(".") %> <% if total_cms_service_days_units[1]== "00" or total_cms_service_days_units[1]== "0" %> <% cms_service_days_units=total_cms_service_days_units[0]%> <% end%><%end%><%end%>
<% if !@cmsservicelines[j].service_place.blank? %> <% cms_service_place=@cmsservicelines[j].service_place%> <%end%>
<% if !@cmsservicelines[j].diagnosis_pointer.blank? %><% if @cmsservicelines[j].diagnosis_pointer.to_i >0  %> <%cms_diagnosis_pointer=[]%><%diagnosis_pointer=""%><%c=0%> <%while @cmsservicelines[j].diagnosis_pointer>0%><% cms_diagnosis_pointer[c]=@cmsservicelines[j].diagnosis_pointer%10%><%c=c+1%><%@cmsservicelines[j].diagnosis_pointer=@cmsservicelines[j].diagnosis_pointer/10%><%end%><% if cms_diagnosis_pointer.length>= 1 %> <%  cms_diagnosis_pointer=cms_diagnosis_pointer.reverse %><%diagnosis_pointer=cms_diagnosis_pointer[0].to_s%><%end%> <%if cms_diagnosis_pointer!=""%><% if cms_diagnosis_pointer.length> 1 %><% for x in 1..cms_diagnosis_pointer.length-1%><%if cms_diagnosis_pointer[x]!=0%><%if diagnosis_pointer.to_i!=0%><%diagnosis_pointer=diagnosis_pointer+":"+cms_diagnosis_pointer[x].to_s%><%end%><%end%><%end%><%end%><%end%><%end%><%end%>
<%if !@cmsservicelines[j].charges.blank?%><% total_service_line_charge = @cmsservicelines[j].charges.to_s %> <% total_service_line_decimal=total_service_line_charge.split(".") %> <% if total_service_line_decimal[1]== "00" or total_service_line_decimal[1]== "0" %> <% total_service_line_charge=total_service_line_decimal[0]%> <% end%><%end%>
<%if !@cmsservicelines[j].cpt_hcpcts.blank? or !total_service_line_charge.blank? or !cms_service_days_units.blank? or !cms_service_place.blank? or !diagnosis_pointer.blank? or !@cmsservicelines[j].emg.blank? or !@cmsservicelines[j].epsdt.blank? or !@cmsservicelines[j].family_plan.blank?%>
SV1*HC<% var = ":"%><%= var%><% if !@cmsservicelines[j].cpt_hcpcts.blank? %><%= @cmsservicelines[j].cpt_hcpcts.strip rescue nil%><%end%><%if !modifier1.blank?%><%= modifier1.strip rescue nil%><%end%><%if !modifier2.blank?%><%=modifier2.strip rescue nil%><%end%><%if !modifier3.blank?%><%=modifier3.strip rescue nil%><%end%><%if !modifier4.blank?%><%=modifier4.strip rescue nil%><%end%>*<%if !total_service_line_charge.blank?%><%=total_service_line_charge.to_s.strip rescue nil%><%end%><%if !cms_service_days_units.blank?%>*UN*<%=cms_service_days_units.strip rescue nil%><%elsif !minutes.blank?%>*MJ*<%=minutes.strip rescue nil%><%end%><%if !cms_service_place.blank?%>*<%= cms_service_place.strip rescue nil %><%else%><%='*'%><%end%><%if !diagnosis_pointer.blank?%>**<%= diagnosis_pointer.strip rescue nil%><%end%><%if (!@cmsservicelines[j].emg.blank? and @cmsservicelines[j].emg.strip!="N") or (!@cmsservicelines[j].family_plan.blank? and @cmsservicelines[j].family_plan.strip=="Y") %>**<%if !@cmsservicelines[j].emg.blank?%><%if @cmsservicelines[j].emg.strip!="N"%><%= @cmsservicelines[j].emg.strip%><%end%><%end%><%end%><%if (!@cmsservicelines[j].epsdt.blank? and @cmsservicelines[j].epsdt.strip!="N") or (!@cmsservicelines[j].family_plan.blank? and @cmsservicelines[j].family_plan.strip=="Y") %>**<%if !@cmsservicelines[j].epsdt.blank?%><%if @cmsservicelines[j].epsdt.strip.upcase!="N" and @cmsservicelines[j].epsdt.strip.upcase!="NO"%>Y<%end%><%end%><%end%><%if !@cmsservicelines[j].family_plan.blank? and @cmsservicelines[j].family_plan.strip=="Y"%>*<%= @cmsservicelines[j].family_plan.strip rescue nil%><%end%>~<%count=count+1%>
<%end%>
<% cms_service_to_date = ""%><% if !@cmsservicelines[j].service_to_date.blank? %> <%  cms_service_to_date="-"+@cmsservicelines[j].service_to_date.strftime("%Y%m%d") %> <%rd8="RD8"%><%else%><%rd8="D8"%><% end %>
<%if rd8!="" or @cmsservicelines[j].service_from_date.strftime("%Y%m%d").to_s!="" or cms_service_to_date!=""%>
DTP*472*<%=rd8.strip rescue nil%><% if @cmsservicelines[j].service_from_date.to_s!="" %>*<% if @cmsservicelines[j].service_from_date.strftime("%Y%m%d").to_s!="" %><%= @cmsservicelines[j].service_from_date.strftime("%Y%m%d").to_s.strip rescue nil%><%end%><%end%><%if cms_service_to_date.to_s!=""%><%= cms_service_to_date.to_s.strip rescue nil%><%end%>~<%count=count+1%>
<%end%>
<%if !@cmsservicelines[j].rendering_provider_qualifier_npi_id.blank? %>
NM1*82*2*NPI <%= @cmsservicelines[j].rendering_provider_qualifier_npi_id.to_s.strip rescue nil%>*****XX*<%= @cmsservicelines[j].rendering_provider_qualifier_npi_id.to_s.strip rescue nil%>~ <%count=count+1%>
PRV*PE*ZZ*208D00000X~<%count=count+1%>
<%end%>
<%if !@cmsservicelines[j].rendering_provider_qualifier_npi_id.blank? %>
<%if !@cmsservicelines[j].qual_id.blank? or !@cmsservicelines[j].rendering_provider_id.blank?%>
<%if !@cmsservicelines[j].rendering_provider_id.blank?%>REF*<%=@cmsservicelines[j].qual_id_for_837.strip rescue nil%>*<%=  @cmsservicelines[j].rendering_provider_id.strip rescue nil%>~<%count=count+1%><%end%>
<%end%>
<%end%>
<%end%>
<% end %><% end %>
SE*<%= count+1%>*<%= sprintf("%04d",offset + i + 1) %>~<% end %>
GE*<%= @cms1500s.length %>*2831~
IEA*1*<%= sprintf("%09d",id_837)%>~